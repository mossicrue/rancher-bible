# Ingress
The Ingress Controller installed by default is the Nginx ingress controller, but this can be disabled in the cluster options at install or after. Once removed, you can install another ingress controller like Traefik or HAProxy. Which controller you choose is a matter of personal preference.  
The Nginx ingress controller works fine, and most of the examples for ingress out on the Internet have annotations for Nginx.

Rancher can generate an xip.io hostname, which is useful for development or demonstration purposes.  

Worker nodes running in an environment like AWS don't know their external address by default, so if you plan to use the xip.io feature of the Ingress resources in Rancher, launch your clusters with a configuration that tells Kubernetes the internal and external addresses of the nodes.  
This configuration appears as a label on the node of `rke.cattle.io/external-ip` and `rke.cattle.io/internal-ip`.  
The xip.io configuration will take the external-ip address if present, and the node address if it is not.

You can also specify a hostname directly, or if the ingress controller supports it, you can designate an Ingress to be the default backend for the ingress controller.  
Traffic that arrives on a host and doesn't match any destination will go to the default backend.  
Usually this returns a 404 page, but with a custom backend you can present users with a different experience.

When creating an ingress, you have the option to use a Service entry or to send traffic directly to a Workload.  
The latter exists to route traffic to workloads that don't expose ports via a Service entry.  
Rancher labels the workload and creates a service that uses the label as a selector. The ingress sends traffic to that service.

> **NOTE:** Future versions of Rancher will only use Services, so we recommend that you expose your workloads with Service entries and use those with the Ingress configuration.

## TLS Certificates
If you've added certificates to Rancher, either statically or dynamically, they will be made available by the system for you to attach to Ingresses.

If you've installed Cert Manager, you can annotate your Ingress to request a certificate from the issuer when you deploy the Ingress.  
This is not integrated into the UI and requires that you edit the YAML directly after creating the Ingress.

## DNS Considerations
By default, an ingress controller runs as a DaemonSet and listens on every worker node in the cluster.  
It can also be configured as a Deployment that listens on select nodes in the cluster.  
In either case, how do you get traffic to it reliably?

You can put every node in DNS, but round-robin DNS will fail if one node goes down.

The answer is that you still need an external load balancer of some kind.  
The difference is that your external load balancer can now be a dumb Layer 4 load balancer, sending all TCP traffic for ports 80 and 443 directly to the worker nodes where the ingress controller is running.  
The drawback to this is that you won't have information about the client. Since the stream is an unmodified TCP stream, there is no XForwarded-For HTTP header.  
If your application requires client data, you'll need to explore an additional means of acquiring that information.

## Create an Ingress Rule
In this example is present a simple deployment of an httpd app that is listening on port 8080 through a ClusterIP service created with the deploy.  
Next step is to create an Ingress that will allow user to access this application from outside the cluster.

### Add Ingress in Cluster Explorer
- Click the dropdown menu on the top left of the page and select "Clusetr Explorer"

- In the "Service Discovery" section choose "Ingress" and click on the "Create" button

- Fill the form with the requested data and click the "Create" button

- Click the "Create" button and wait that the label of the ingress becomes "Active" to test if works

### Add Ingress in Cluster Manager
- Click on the dropdown cluster / project menu on the top and select the project where create the External Name services

- In the new page click "Resources" on the dropdown menu and select the "Workloads" entry

- Choose to visualize the "Load Balancing" sections and then click the "Add Record" button

- Fill the form with the requested data by assuring to select a target service and not a workloads for the ingress

- Click the "Create" button and wait that the label of the ingress becomes "Active" to test if works

## Add TLS support to an Ingress
To add a tls certificated generated by the cert-manager component, if installed, just add the following data in the ingress yaml.

### TLS Block
First, the TLS block that need to be added under the spec section
```yaml
spec:
  tls:
  - hosts:
    - demo-app.httpd-test.com
    secretName: demo-app-httpd-test-com-crt
```

> **NOTE:** If the ingress use multiple hostnames, add it under the hosts key

Now cert-manager will create the certification on demand and store it in the secret passed.

### Annotations Block
Depending on how cert-manager is configured for your cluster you might have to tell it to use an issuer or a cluster issuer for the certificate.

If the cluster use a cluster-issuer, that aren't scoped to a namespace, it's possible to add in the annotations exactly which cluster issuer to use.

If cert-manager is installed with default values, it's possible to use the following annoation to run all certs through this default issuer

```yaml
metadata:
  annotations:
    kubernetes.io/tls-acme: "true"
```
